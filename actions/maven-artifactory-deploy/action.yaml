name: 'Artifactory Deploy'
description: 'Deploy artifacts to Artifactory'

inputs:
  context-url:
    description: 'URI of the Artifactory server'
    required: false
    default: 'https://repo.spring.io'
  username:
    description: 'Artifactory username'
    required: true
  password:
    description: 'Artifactory password'
    required: true
  build-name:
    description: 'Name of the build'
    required: true
  build-uri:
    description: 'URI of the build that produced the artifacts that are to be deployed'
    required: false
    default: "${{ format('{0}/{1}/actions/runs/{2}', github.server_url, github.repository, github.run_id) }}"
  project:
    description: 'BuildInfo Project in which build info should be stored'
    required: false
    default: ''
  repository:
    description: 'Artifactory repository to which the artifacts should be deployed'
    required: false
    default: 'libs-snapshot-local'
  skip-tests:
    description: 'Whether to skip tests during deployment'
    required: false
    default: 'false'
  additional-options:
    description: 'Additional Maven options to pass during deployment'
    required: false
    default: ''
runs:
  using: composite
  steps:
    - shell: bash
      env:
        CONTEXT_URL: '${{ inputs.context-url }}'
        USERNAME: '${{ inputs.username }}'
        PASSWORD: '${{ inputs.password }}'
        REPOSITORY: '${{ inputs.repository }}'
        PROJECT: '${{ inputs.project }}'
        BUILD_NAME: '${{ inputs.build-name }}'
        BUILD_URI: '${{ inputs.build-uri }}'
        SKIP_TESTS: '${{ inputs.skip-tests }}'
        ADDITIONAL_OPTIONS: '${{ inputs.additional-options }}'
        BUILD_NUMBER: ${{ format('{0}-{1}-build-{2}', inputs.build-name, (github.head_ref || github.ref_name), github.run_number ) }}
      run: |
        ADDITIONAL_MAVEN_OPTS=""
        if [[ -f "settings.xml" ]]; then
          ADDITIONAL_MAVEN_OPTS="-s settings.xml"
        fi
        ./mvnw ${ADDITIONAL_MAVEN_OPTS} -Pci,artifactory ${ADDITIONAL_OPTIONS} \
        -Dartifactory.server="${CONTEXT_URL}" \
        -Dartifactory.username="${USERNAME}" \
        -Dartifactory.password="${PASSWORD}" \
        -Dartifactory.staging-repository="${REPOSITORY}" \
        -Dartifactory.project="${PROJECT}" \
        -Dartifactory.build-name="${BUILD_NAME}" \
        -Dartifactory.build-number="${BUILD_NUMBER}" \
        -DBUILD_URL="${BUILD_URI}" \
        -Dmaven.test.skip=${SKIP_TESTS} -U -B\
        clean deploy
    - name: Test Summary
      uses: spring-projects/spring-data-build/actions/test-summary@main
      with:
        paths: '**/TEST-*.xml'
      if: always()
